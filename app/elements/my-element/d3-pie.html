
<link rel="import" href="../../bower_components/polymer/polymer.html">  
<link rel="import" href="../../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">

<dom-module id="d3-pie">
    <template>
         <style>
            :host {
                display: block;
                /*height: 400px;*/
                border-width: 3px;
                border-style: solid;
                border-color: red;
            }
            text {
              fill: white;
            }
            svg {
              /*float: right;*/
              margin: 0 0px 0 0;
            }
            .arc path {
              stroke: #fff;
            }
        </style>
        
        <svg id="svg" viewBox="0 0 500 500" perserveAspectRatio="xMinYMid"></svg>
    </template>
    <script>
        Polymer({
            is: 'd3-pie',
            behaviors: [
              Polymer.IronResizableBehavior
            ],
            listeners: {
              'iron-resize': '_onIronResize'
            },
            properties: {
                dataName:{
                    type: String,
                    //value: 'Welcome!',
                    //notify: true
                },
                dataArray:{
                    type: Array,
                    observer: '_dataArrayChanged'
                },
                color:{
                    type: Object,
                },
                arc:{
                    type: Object,
                },
                pie:{
                    type: Object,
                },
                svg:{
                    type: Object,
                },
                  x: {
                    type: Number,
                    value: 0
                  },
                  y: {
                    type: Number,
                    value: 0
                  }
            },
            _dataArrayChanged: function(newValue, oldValue){
                console.log("QQ"+newValue); 
                this.drawChart(newValue);
            },
            ready: function() {
                console.log("pie ready:");
                this.setD3(500, 500);
            },
            
            attached: function(){
                this.async(this.notifyResize, 1);
            },
            
            setD3: function(width, height){
                //var width = 500,
                 // height = 500,
                 var radius = Math.min(width, height) / 2;

              this.color = d3.scale.ordinal()
                  .range(["green", "orange", "blue", "red"]);

              this.arc = d3.svg.arc()
                  .outerRadius(radius - 10)
                  .innerRadius(0);

              this.pie = d3.layout.pie()
                  .sort(null)
                  .value(function(d) { return d.amount; });

              this.svg = d3.select(this.$.svg)
                  //.attr("width", width)
                  //.attr("height", height)
                .append("g")
                  .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");      
            },
            
            drawChart: function (data) {
              var me = this;
              me.data=data;
              me.data.forEach(function(d) {
                d.amount = +d.amount;
              });

              me.g = me.svg.selectAll(".arc")
                  .data(me.pie(me.data))
                .enter().append("g")
                  .attr("class", "arc");

              me.g.append("path")
                  .attr("d", me.arc)
                  .style("fill", function(d) { return me.color(d.data.type); });

              me.g.append("text")
                  .attr("transform", function(d) { return "translate(" + me.arc.centroid(d) + ")"; })
                  .attr("dy", ".35em")
                  .style("text-anchor", "middle")
                  .text(function(d) { return d.data.type; });
            },
            /*
            urlChanged: function (oldValue, newValue) {
              if(newValue && oldValue) {
                this.getData();
              }
            }
            */
            get parent() {
              if (this.parentNode.nodeType === Node.DOCUMENT_FRAGMENT_NODE) {
                return this.parentNode.host;
              }
              return this.parentNode;
            },
            _onIronResize: function() {
              this.x = Math.floor(this.parent.offsetWidth );
              this.y = Math.floor(this.parent.offsetHeight );
              //console.log("x="+x+", y="+y);    
              this.svg.attr("width", this.x);
              this.svg.attr("height", this.x);
            }
        });
    </script>
</dom-module>